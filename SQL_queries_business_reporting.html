<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Seoul Korean Bakery - Oracle SQL Code Examples</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 3px solid #3498db;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        h2 {
            color: #34495e;
            margin-top: 50px;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-left: 6px solid #3498db;
            padding-left: 20px;
            background-color: #ecf0f1;
            padding: 15px 20px;
            border-radius: 5px;
        }

        h3 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 5px;
        }

        .code-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .code-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .code-description {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-style: italic;
            color: #6c757d;
        }

        pre {
            margin: 0 !important;
            background-color: #2d3748 !important;
            border-radius: 0 !important;
        }

        pre code {
            font-size: 0.9em;
            line-height: 1.5;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .copy-button:hover {
            opacity: 1;
        }

        .code-container {
            position: relative;
        }

        .toc {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .toc h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .highlight-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            pre code {
                font-size: 0.8em;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>

<body>
    <h1>Sweet Seoul Korean Bakery<br>Oracle 19c Database Business Reporting</h1>

    <div class="toc">
        <h3>Table of Contents</h3>
        <ul>
            <li><a href="#req01">Busines Reporting Requirement 01</a></li>
            <li><a href="#req02">Busines Reporting Requirement 02</a></li>
            <li><a href="#req03">Busines Reporting Requirement 03</a></li>
            <li><a href="#req04">Busines Reporting Requirement 04</a></li>
            <li><a href="#req05">Busines Reporting Requirement 05</a></li>
            <li><a href="#req06">Busines Reporting Requirement 06</a></li>
            <li><a href="#req07">Busines Reporting Requirement 07</a></li>
        </ul>
    </div>

    <div class="highlight-note">
        <strong>Note:</strong> This Oracle 19c database script creates
    </div>


    <div class="code-section">
        <div class="code-header">Global Formatting</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Set up global formatting for all queries
SET LINESIZE 250
SET PAGESIZE 50
SET TRIMOUT ON
SET TRIMSPOOL ON
SET TAB OFF
SET WRAP ON
SET HEADING ON
SET UNDERLINE ON
SET FEEDBACK ON
SET ECHO OFF
SET VERIFY OFF
SET NUMFORMAT 999,999,990.99
ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD';
            </code></pre>
        </div>
    </div>


    <h2 id="req01">Busines Reporting Requirement 01</h2>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Best-selling items comparison across online and in-store channels
PROMPT ===== PRODUCT PERFORMANCE: ONLINE VS IN-STORE COMPARISON =====

-- Format specific columns
COLUMN product_id FORMAT 999 HEADING 'ID'
COLUMN product_name FORMAT A25 HEADING 'Product Name'
COLUMN category FORMAT A12 HEADING 'Category'
COLUMN kpop_anime_tie_in FORMAT A15 HEADING 'K-Pop/Anime'
COLUMN online_quantity_sold FORMAT 999,999 HEADING 'Online|Quantity'
COLUMN online_revenue FORMAT $999,999.99 HEADING 'Online|Revenue'
COLUMN online_avg_price FORMAT $999.99 HEADING 'Online|Avg Price'
COLUMN in_store_quantity_sold FORMAT 999,999 HEADING 'In-Store|Quantity'
COLUMN in_store_revenue FORMAT $999,999.99 HEADING 'In-Store|Revenue'
COLUMN in_store_avg_price FORMAT $999.99 HEADING 'In-Store|Avg Price'
COLUMN total_quantity_sold FORMAT 999,999 HEADING 'Total|Quantity'
COLUMN total_revenue FORMAT $999,999.99 HEADING 'Total|Revenue'
COLUMN online_quantity_percentage FORMAT 990.9 HEADING 'Online %'
COLUMN in_store_quantity_percentage FORMAT 990.9 HEADING 'In-Store %'
COLUMN preferred_channel FORMAT A10 HEADING 'Preferred|Channel'

SELECT 
    p.product_id,
    p.product_name,
    p.category,
    p.kpop_anime_tie_in,
    -- Online sales metrics (UPDATED: Proper discount handling)
    SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
             THEN oi.quantity ELSE 0 END) AS online_quantity_sold,
    ROUND(SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END), 2) AS online_revenue,
    -- ADDED: Average price per unit online
    ROUND(SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END) / 
          NULLIF(SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
                          THEN oi.quantity ELSE 0 END), 0), 2) AS online_avg_price,
    -- In-store sales metrics (UPDATED: Proper discount handling)
    SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
             THEN oi.quantity ELSE 0 END) AS in_store_quantity_sold,
    ROUND(SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END), 2) AS in_store_revenue,
    -- ADDED: Average price per unit in-store
    ROUND(SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END) / 
          NULLIF(SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
                          THEN oi.quantity ELSE 0 END), 0), 2) AS in_store_avg_price,
    -- Total sales metrics (UPDATED: Include discount calculations)
    SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) AS total_quantity_sold,
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END), 2) AS total_revenue,
    -- Channel distribution (UPDATED: Only count valid orders)
    ROUND(SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
                   THEN oi.quantity ELSE 0 END) / 
          NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) * 100, 1) AS online_quantity_percentage,
    ROUND(SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
                   THEN oi.quantity ELSE 0 END) / 
          NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) * 100, 1) AS in_store_quantity_percentage,
    -- Preferred channel (based on quantity sold)
    CASE 
        WHEN SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
                       THEN oi.quantity ELSE 0 END) > 
             SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
                       THEN oi.quantity ELSE 0 END) THEN 'Online'
        WHEN SUM(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') 
                       THEN oi.quantity ELSE 0 END) < 
             SUM(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') 
                       THEN oi.quantity ELSE 0 END) THEN 'In-Store'
        WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) > 0 THEN 'Equal'
        ELSE 'No Sales'
    END AS preferred_channel
FROM 
    PRODUCTS p
LEFT JOIN 
    ORDER_ITEMS oi ON p.product_id = oi.product_id
LEFT JOIN 
    ORDERS o ON oi.order_id = o.order_id
GROUP BY 
    p.product_id, p.product_name, p.category, p.kpop_anime_tie_in
HAVING 
    SUM(CASE WHEN o.order_status NOT IN ('Canceled') OR o.order_status IS NULL THEN oi.quantity ELSE 0 END) > 0
    OR SUM(CASE WHEN o.order_status NOT IN ('Canceled') OR o.order_status IS NULL THEN oi.quantity ELSE 0 END) IS NULL
ORDER BY 
    total_revenue DESC NULLS LAST;
                
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Inventory turnover rates to identify fast-moving vs. slow-moving products
PROMPT 
PROMPT ===== INVENTORY TURNOVER ANALYSIS =====

-- Format specific columns
CLEAR COLUMNS

COLUMN product_id FORMAT 999 HEADING 'ID'
COLUMN product_name FORMAT A25 HEADING 'Product Name'
COLUMN category FORMAT A12 HEADING 'Category'
COLUMN current_stock FORMAT 9,999 HEADING 'Current|Stock'
COLUMN total_quantity_sold FORMAT 9,999 HEADING 'Quantity|Sold'
COLUMN inventory_turnover_ratio FORMAT 990.99 HEADING 'Turnover|Ratio'
COLUMN product_velocity FORMAT A15 HEADING 'Velocity'
COLUMN stock_status FORMAT A15 HEADING 'Stock Status'
COLUMN estimated_days_supply FORMAT 9,990 HEADING 'Est. Days|Supply'
COLUMN avg_daily_sales FORMAT 990.99 HEADING 'Avg Daily|Sales'
COLUMN last_sale_date FORMAT A10 HEADING 'Last Sale'

SELECT 
    p.product_id,
    p.product_name,
    p.category,
    -- Inventory metrics
    i.current_stock,
    -- Sales metrics for turnover calculation (UPDATED: Exclude canceled orders)
    COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) AS total_quantity_sold,
    -- ADDED: Average daily sales for better forecasting
    ROUND(
        COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
        NULLIF(COUNT(DISTINCT CASE WHEN o.order_status NOT IN ('Canceled') THEN TRUNC(o.order_date) END), 0), 
        2
    ) AS avg_daily_sales,
    -- Inventory turnover ratio and categorization (UPDATED: Better calculation)
    CASE 
        WHEN i.current_stock = 0 THEN NULL
        ELSE ROUND(
            COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
            NULLIF(i.current_stock, 0), 2)
    END AS inventory_turnover_ratio,
    -- UPDATED: More nuanced velocity classification
    CASE 
        WHEN i.current_stock = 0 THEN 'Out of Stock'
        WHEN COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) = 0 THEN 'No Sales'
        WHEN COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
             NULLIF(i.current_stock, 0) > 3 THEN 'Very Fast'
        WHEN COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
             NULLIF(i.current_stock, 0) > 1.5 THEN 'Fast-Moving'
        WHEN COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
             NULLIF(i.current_stock, 0) BETWEEN 0.5 AND 1.5 THEN 'Medium-Moving'
        ELSE 'Slow-Moving'
    END AS product_velocity,
    -- Stock status indicators (UPDATED: More detailed status logic)
    CASE 
        WHEN i.current_stock = 0 THEN 'Out of Stock'
        WHEN i.current_stock <= i.min_stock_level THEN 'Critical Stock'
        WHEN i.current_stock <= i.reorder_point THEN 'Reorder Soon'
        WHEN i.current_stock >= i.max_stock_level * 0.9 THEN 'Overstocked'
        ELSE 'Adequate Stock'
    END AS stock_status,
    -- Days of supply remaining (UPDATED: Better calculation with valid orders only)
    CASE
        WHEN COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) = 0 THEN NULL 
        ELSE ROUND(
            i.current_stock / NULLIF(
                COALESCE(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
                NULLIF(COUNT(DISTINCT CASE WHEN o.order_status NOT IN ('Canceled') THEN TRUNC(o.order_date) END), 0), 
                0
            ), 0)
    END AS estimated_days_supply,
    -- ADDED: Last sale date for inactive product identification
    MAX(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END) AS last_sale_date
FROM 
    PRODUCTS p
JOIN 
    INVENTORY i ON p.product_id = i.product_id
LEFT JOIN 
    ORDER_ITEMS oi ON p.product_id = oi.product_id
LEFT JOIN 
    ORDERS o ON oi.order_id = o.order_id
GROUP BY 
    p.product_id, p.product_name, p.category, 
    i.current_stock, i.min_stock_level, i.reorder_point, i.max_stock_level
ORDER BY 
    CASE 
        WHEN i.current_stock = 0 THEN 1
        WHEN i.current_stock <= i.min_stock_level THEN 2
        ELSE 3
    END,
    inventory_turnover_ratio DESC NULLS LAST;
                
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Seasonal and limited edition product performance
PROMPT 
PROMPT ===== SEASONAL & LIMITED EDITION PERFORMANCE =====

-- Format specific columns
CLEAR COLUMNS

COLUMN product_id FORMAT 999 HEADING 'ID'
COLUMN product_name FORMAT A25 HEADING 'Product Name'
COLUMN category FORMAT A12 HEADING 'Category'
COLUMN is_seasonal FORMAT A5 HEADING 'Seasn'
COLUMN is_limited_edition FORMAT A5 HEADING 'Ltd Ed'
COLUMN expiry_date FORMAT A10 HEADING 'Expiry Date'
COLUMN days_until_expiry FORMAT 9999 HEADING 'Days|Left'
COLUMN total_quantity_sold FORMAT 9,999 HEADING 'Qty Sold'
COLUMN total_revenue FORMAT $99,999.99 HEADING 'Revenue'
COLUMN avg_selling_price FORMAT $999.99 HEADING 'Avg Price'
COLUMN current_stock FORMAT 9,999 HEADING 'Current|Stock'
COLUMN daily_sales_rate FORMAT 990.9 HEADING 'Daily|Sales'
COLUMN sell_through_percentage FORMAT 990.9 HEADING 'Sell-Thru %'
COLUMN seasonal_performance FORMAT A15 HEADING 'Performance'
COLUMN urgency_level FORMAT A10 HEADING 'Urgency'

SELECT
    p.product_id,
    p.product_name,
    p.category,
    -- Product attributes
    CASE WHEN p.seasonal = 1 THEN 'Yes' ELSE 'No' END AS is_seasonal,
    CASE WHEN p.limited_edition = 1 THEN 'Yes' ELSE 'No' END AS is_limited_edition,
    p.expiry_date,
    -- ADDED: Days until expiry for urgency assessment
    CASE 
        WHEN p.expiry_date IS NOT NULL THEN TRUNC(p.expiry_date - SYSDATE)
        ELSE NULL
    END AS days_until_expiry,
    -- Sales metrics (UPDATED: Exclude canceled orders and include discounts)
    SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) AS total_quantity_sold,
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END), 2) AS total_revenue,
    -- ADDED: Average selling price (after discounts)
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END) / 
          NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0), 2) AS avg_selling_price,
    -- Inventory metrics
    i.current_stock,
    -- Temporal metrics for seasonal items (UPDATED: Better date handling)
    CASE
        WHEN (p.seasonal = 1 OR p.limited_edition = 1) AND p.expiry_date IS NOT NULL THEN 
            ROUND(
                SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                NULLIF(GREATEST(TRUNC(LEAST(p.expiry_date, SYSDATE) - 
                               COALESCE(MIN(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END), SYSDATE)), 1), 0), 
                1
            )
        WHEN (p.seasonal = 1 OR p.limited_edition = 1) THEN
            ROUND(
                SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                NULLIF(COUNT(DISTINCT CASE WHEN o.order_status NOT IN ('Canceled') THEN TRUNC(o.order_date) END), 0), 
                1
            )
        ELSE NULL
    END AS daily_sales_rate,
    -- Sell-through rate (UPDATED: Better initial stock estimation)
    CASE
        WHEN p.seasonal = 1 OR p.limited_edition = 1 THEN
            ROUND(
                SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) + i.current_stock, 0) * 100, 
                1
            )
        ELSE NULL
    END AS sell_through_percentage,
    -- Performance classification (UPDATED: More nuanced performance metrics)
    CASE
        WHEN p.seasonal = 1 OR p.limited_edition = 1 THEN
            CASE
                WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                     NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) + i.current_stock, 0) >= 0.9 
                     THEN 'Excellent'
                WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                     NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) + i.current_stock, 0) >= 0.75 
                     THEN 'Very Good'
                WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                     NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) + i.current_stock, 0) >= 0.5 
                     THEN 'Good'
                WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) / 
                     NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) + i.current_stock, 0) >= 0.25 
                     THEN 'Fair'
                ELSE 'Poor'
            END
        ELSE 'Regular Product'
    END AS seasonal_performance,
    -- ADDED: Urgency level for action planning
    CASE
        WHEN p.expiry_date IS NOT NULL THEN
            CASE
                WHEN TRUNC(p.expiry_date - SYSDATE) <= 3 AND i.current_stock > 0 THEN 'Emergency'
                WHEN TRUNC(p.expiry_date - SYSDATE) <= 7 AND i.current_stock > 0 THEN 'Critical'
                WHEN TRUNC(p.expiry_date - SYSDATE) <= 14 AND i.current_stock > 0 THEN 'High'
                WHEN TRUNC(p.expiry_date - SYSDATE) <= 30 AND i.current_stock > 0 THEN 'Medium'
                WHEN TRUNC(p.expiry_date - SYSDATE) <= 60 AND i.current_stock > 0 THEN 'Low'
                WHEN TRUNC(p.expiry_date - SYSDATE) < 0 THEN 'Expired'
                ELSE 'Sold Out'
            END
        WHEN p.limited_edition = 1 AND i.current_stock <= i.min_stock_level THEN 'Critical'
        WHEN p.limited_edition = 1 AND i.current_stock <= i.reorder_point THEN 'Medium'
        ELSE 'Normal'
    END AS urgency_level
FROM 
    PRODUCTS p
JOIN 
    INVENTORY i ON p.product_id = i.product_id
LEFT JOIN 
    ORDER_ITEMS oi ON p.product_id = oi.product_id
LEFT JOIN 
    ORDERS o ON oi.order_id = o.order_id
WHERE 
    p.seasonal = 1 OR p.limited_edition = 1
GROUP BY 
    p.product_id, p.product_name, p.category, p.seasonal, 
    p.limited_edition, p.expiry_date, i.current_stock, i.min_stock_level, i.reorder_point
ORDER BY 
    -- UPDATED: Better sorting - urgency first, then performance
    CASE 
        WHEN p.expiry_date IS NOT NULL AND TRUNC(p.expiry_date - SYSDATE) <= 3 THEN 1
        WHEN p.expiry_date IS NOT NULL AND TRUNC(p.expiry_date - SYSDATE) <= 7 THEN 2
        WHEN p.expiry_date IS NOT NULL AND TRUNC(p.expiry_date - SYSDATE) <= 14 THEN 3
        WHEN p.expiry_date IS NOT NULL AND TRUNC(p.expiry_date - SYSDATE) <= 30 THEN 4
        WHEN p.limited_edition = 1 AND i.current_stock <= i.min_stock_level THEN 5
        ELSE 6
    END,
    sell_through_percentage DESC NULLS LAST;
                
            </code></pre>
        </div>
    </div>


    <h2 id="req02">Busines Reporting Requirement 02</h2>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Subscription Growth & Status Trends Over Time
PROMPT ===== SUBSCRIPTION GROWTH & STATUS TRENDS =====

-- Format specific columns for this report
CLEAR COLUMNS

COLUMN subscription_month FORMAT A10 HEADING 'Month'
COLUMN new_subscriptions FORMAT 999 HEADING 'New|Subs'
COLUMN active_subscriptions FORMAT 999 HEADING 'Active|Subs'
COLUMN paused_subscriptions FORMAT 999 HEADING 'Paused|Subs'
COLUMN canceled_subscriptions FORMAT 999 HEADING 'Canceled|Subs'
COLUMN cumulative_subscriptions FORMAT 9,999 HEADING 'Cumulative|Total'
COLUMN month_over_month_growth_pct FORMAT 990.9 HEADING 'MoM Growth|%'
COLUMN active_rate FORMAT 990.9 HEADING 'Active|Rate %'
COLUMN avg_monthly_price FORMAT $999.99 HEADING 'Avg Monthly|Price'
COLUMN auto_renewal_rate FORMAT 990.9 HEADING 'Auto-Renewal|Rate %'

WITH monthly_subscriptions AS (
    SELECT 
        TO_CHAR(start_date, 'YYYY-MM') AS subscription_month,
        COUNT(*) AS new_subscriptions,
        -- Current status counts (based on current subscription status)
        SUM(CASE WHEN subscription_status = 'Active' THEN 1 ELSE 0 END) AS active_subscriptions,
        SUM(CASE WHEN subscription_status = 'Paused' THEN 1 ELSE 0 END) AS paused_subscriptions,
        SUM(CASE WHEN subscription_status = 'Canceled' THEN 1 ELSE 0 END) AS canceled_subscriptions,
        -- UPDATED: Average pricing and auto-renewal metrics
        ROUND(AVG(monthly_price), 2) AS avg_monthly_price,
        ROUND(SUM(CASE WHEN auto_renewal = 1 THEN 1 ELSE 0 END) / COUNT(*) * 100, 1) AS auto_renewal_rate
    FROM 
        SUBSCRIPTIONS
    WHERE 
        start_date IS NOT NULL
    GROUP BY 
        TO_CHAR(start_date, 'YYYY-MM')
)
SELECT 
    subscription_month,
    new_subscriptions,
    active_subscriptions,
    paused_subscriptions,
    canceled_subscriptions,
    SUM(new_subscriptions) OVER (ORDER BY subscription_month) AS cumulative_subscriptions,
    -- Month-over-month growth calculation
    CASE 
        WHEN LAG(new_subscriptions) OVER (ORDER BY subscription_month) > 0 THEN
            ROUND((new_subscriptions - LAG(new_subscriptions) OVER (ORDER BY subscription_month)) / 
                  LAG(new_subscriptions) OVER (ORDER BY subscription_month) * 100, 1)
        ELSE NULL
    END AS month_over_month_growth_pct,
    -- Active subscription rate
    ROUND(active_subscriptions / 
          NULLIF(active_subscriptions + paused_subscriptions + canceled_subscriptions, 0) * 100, 1) AS active_rate,
    avg_monthly_price,
    auto_renewal_rate
FROM 
    monthly_subscriptions
ORDER BY 
    subscription_month DESC;
                
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Subscription Type Performance Analysis
PROMPT 
PROMPT ===== SUBSCRIPTION TYPE PERFORMANCE ANALYSIS =====

CLEAR COLUMNS

COLUMN subscription_type FORMAT A12 HEADING 'Subscription|Type'
COLUMN billing_cycle FORMAT A15 HEADING 'Billing Cycle|Months'
COLUMN total_subscriptions FORMAT 9,999 HEADING 'Total|Subscriptions'
COLUMN active_subscriptions FORMAT 9,999 HEADING 'Active|Subscriptions'
COLUMN avg_monthly_price FORMAT $999.99 HEADING 'Avg Monthly|Price'
COLUMN total_monthly_revenue FORMAT $99,999.99 HEADING 'Monthly|Revenue'
COLUMN avg_customer_lifetime FORMAT 999 HEADING 'Avg Lifetime|Days'
COLUMN churn_rate FORMAT 990.9 HEADING 'Churn|Rate %'
COLUMN gift_subscription_pct FORMAT 990.9 HEADING 'Gift Sub|%'
COLUMN auto_renewal_pct FORMAT 990.9 HEADING 'Auto-Renewal|%'

SELECT 
    s.subscription_type,
    -- UPDATED: Billing cycle analysis
    CASE 
        WHEN s.billing_cycle_months = 1 THEN 'Monthly'
        WHEN s.billing_cycle_months = 3 THEN 'Quarterly'
        WHEN s.billing_cycle_months = 6 THEN 'Semi-Annual'
        WHEN s.billing_cycle_months = 12 THEN 'Annual'
        ELSE s.billing_cycle_months || ' Months'
    END AS billing_cycle,
    COUNT(*) AS total_subscriptions,
    SUM(CASE WHEN s.subscription_status = 'Active' THEN 1 ELSE 0 END) AS active_subscriptions,
    ROUND(AVG(s.monthly_price), 2) AS avg_monthly_price,
    -- UPDATED: Total monthly recurring revenue (MRR)
    ROUND(SUM(CASE WHEN s.subscription_status = 'Active' THEN s.monthly_price ELSE 0 END), 2) AS total_monthly_revenue,
    -- Average customer lifetime (start to end/cancel date)
    ROUND(AVG(
        CASE 
            WHEN s.end_date IS NOT NULL THEN s.end_date - s.start_date
            WHEN s.subscription_status = 'Canceled' THEN SYSDATE - s.start_date
            ELSE SYSDATE - s.start_date
        END
    ), 0) AS avg_customer_lifetime,
    -- Churn rate calculation
    ROUND(SUM(CASE WHEN s.subscription_status = 'Canceled' THEN 1 ELSE 0 END) / 
          NULLIF(COUNT(*), 0) * 100, 1) AS churn_rate,
    -- Gift subscription percentage
    ROUND(SUM(CASE WHEN s.is_gift = 1 THEN 1 ELSE 0 END) / 
          NULLIF(COUNT(*), 0) * 100, 1) AS gift_subscription_pct,
    -- UPDATED: Auto-renewal rate
    ROUND(SUM(CASE WHEN s.auto_renewal = 1 THEN 1 ELSE 0 END) / 
          NULLIF(COUNT(*), 0) * 100, 1) AS auto_renewal_pct
FROM 
    SUBSCRIPTIONS s
GROUP BY 
    s.subscription_type, s.billing_cycle_months
ORDER BY 
    total_monthly_revenue DESC;
                
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">        
            <pre><code class="language-sql">-- Customer Lifetime Value (CLV) Analysis for Subscriptions
PROMPT 
PROMPT ===== SUBSCRIPTION CUSTOMER LIFETIME VALUE ANALYSIS =====

CLEAR COLUMNS

COLUMN customer_id FORMAT 99999 HEADING 'Customer|ID'
COLUMN customer_name FORMAT A25 HEADING 'Customer Name'
COLUMN subscription_type FORMAT A12 HEADING 'Sub Type'
COLUMN subscription_duration_days FORMAT 9999 HEADING 'Duration|Days'
COLUMN total_subscription_value FORMAT $9,999.99 HEADING 'Total Sub|Value'
COLUMN monthly_value FORMAT $999.99 HEADING 'Monthly|Value'
COLUMN subscription_status FORMAT A10 HEADING 'Status'
COLUMN auto_renewal FORMAT A5 HEADING 'Auto|Renew'
COLUMN delivery_completion_rate FORMAT 990.9 HEADING 'Delivery|Rate %'
COLUMN customer_segment FORMAT A15 HEADING 'Value Segment'

SELECT 
    c.customer_id,
    c.first_name || ' ' || c.last_name AS customer_name,
    s.subscription_type,
    -- Subscription duration calculation
    CASE 
        WHEN s.end_date IS NOT NULL THEN TRUNC(s.end_date - s.start_date)
        WHEN s.subscription_status = 'Canceled' THEN TRUNC(SYSDATE - s.start_date)
        ELSE TRUNC(SYSDATE - s.start_date)
    END AS subscription_duration_days,
    -- Total subscription value
    ROUND(s.monthly_price * 
          (CASE 
               WHEN s.end_date IS NOT NULL THEN MONTHS_BETWEEN(s.end_date, s.start_date)
               WHEN s.subscription_status = 'Canceled' THEN MONTHS_BETWEEN(SYSDATE, s.start_date)
               ELSE MONTHS_BETWEEN(SYSDATE, s.start_date)
           END), 2) AS total_subscription_value,
    s.monthly_price AS monthly_value,
    s.subscription_status,
    CASE WHEN s.auto_renewal = 1 THEN 'Yes' ELSE 'No' END AS auto_renewal,
    -- Delivery completion rate
    ROUND(
        COUNT(CASE WHEN si.delivery_status = 'Delivered' THEN 1 END) / 
        NULLIF(COUNT(si.subscription_item_id), 0) * 100, 1
    ) AS delivery_completion_rate,
    -- Customer value segmentation
    CASE 
        WHEN s.monthly_price * MONTHS_BETWEEN(COALESCE(s.end_date, SYSDATE), s.start_date) >= 500 THEN 'High Value'
        WHEN s.monthly_price * MONTHS_BETWEEN(COALESCE(s.end_date, SYSDATE), s.start_date) >= 200 THEN 'Medium Value'
        WHEN s.monthly_price * MONTHS_BETWEEN(COALESCE(s.end_date, SYSDATE), s.start_date) >= 50 THEN 'Low Value'
        ELSE 'New Customer'
    END AS customer_segment
FROM 
    SUBSCRIPTIONS s
JOIN 
    CUSTOMERS c ON s.customer_id = c.customer_id
LEFT JOIN 
    SUBSCRIPTION_ITEMS si ON s.subscription_id = si.subscription_id
GROUP BY 
    c.customer_id, c.first_name, c.last_name, s.subscription_type, s.start_date, 
    s.end_date, s.monthly_price, s.subscription_status, s.auto_renewal
ORDER BY 
    total_subscription_value DESC;

                
            </code></pre>
        </div>
    </div>


    <h2 id="req03">Busines Reporting Requirement 03</h2>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Marketing Channel Performance Overview
 PROMPT ===== MARKETING CHANNEL PERFORMANCE OVERVIEW =====

-- Format specific columns for this report
CLEAR COLUMNS

COLUMN channel_name FORMAT A25 HEADING 'Marketing Channel'
COLUMN channel_type FORMAT A15 HEADING 'Channel Type'
COLUMN specific_platform FORMAT A20 HEADING 'Platform'
COLUMN acquisition_cost FORMAT $999.99 HEADING 'CAC'
COLUMN customers_acquired FORMAT 999 HEADING 'Customers|Acquired'
COLUMN total_cac_spend FORMAT $99,999.99 HEADING 'Total CAC|Spend'
COLUMN total_orders FORMAT 999 HEADING 'Total|Orders'
COLUMN gross_revenue FORMAT $99,999.99 HEADING 'Gross|Revenue'
COLUMN net_revenue FORMAT $99,999.99 HEADING 'Net Revenue|After Discounts'
COLUMN revenue_per_customer FORMAT $9,999.99 HEADING 'Revenue Per|Customer'
COLUMN net_roi FORMAT 990.9 HEADING 'Net ROI|Ratio'
COLUMN cac_payback_months FORMAT 990.9 HEADING 'CAC Payback|Months'
COLUMN avg_order_value FORMAT $999.99 HEADING 'AOV'
COLUMN customer_ltv FORMAT $9,999.99 HEADING 'Customer|LTV'

-- Enhanced query with proper revenue calculations and profit analysis
SELECT
    mc.channel_name,
    mc.channel_type,
    mc.specific_platform,
    mc.customer_acquisition_cost AS acquisition_cost,
    COUNT(DISTINCT o.customer_id) AS customers_acquired,
    ROUND(mc.customer_acquisition_cost * COUNT(DISTINCT o.customer_id), 2) AS total_cac_spend,
    COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END) AS total_orders,
    -- UPDATED: Gross revenue calculation
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.subtotal + o.tax_amount + o.shipping_cost ELSE 0 END), 2) AS gross_revenue,
    -- UPDATED: Net revenue after all discounts
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END), 2) AS net_revenue,
    -- Revenue per customer (net)
    CASE 
        WHEN COUNT(DISTINCT o.customer_id) > 0 THEN
            ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) / COUNT(DISTINCT o.customer_id), 2)
        ELSE 0
    END AS revenue_per_customer,
    -- UPDATED: Net ROI calculation
    CASE 
        WHEN mc.customer_acquisition_cost * COUNT(DISTINCT o.customer_id) > 0 THEN
            ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) / 
                  (mc.customer_acquisition_cost * COUNT(DISTINCT o.customer_id)), 1)
        ELSE 0
    END AS net_roi,
    -- UPDATED: CAC payback period calculation (assuming quarterly revenue cycles)
    CASE 
        WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) > 0 THEN
            ROUND((mc.customer_acquisition_cost * COUNT(DISTINCT o.customer_id)) / 
                  (SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) / 12), 1)
        ELSE NULL
    END AS cac_payback_months,
    -- ADDED: Average Order Value
    CASE 
        WHEN COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END) > 0 THEN
            ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) / 
                  COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END), 2)
        ELSE 0
    END AS avg_order_value,
    -- ADDED: Estimated Customer Lifetime Value (simplified)
    CASE 
        WHEN COUNT(DISTINCT o.customer_id) > 0 THEN
            ROUND((SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) / COUNT(DISTINCT o.customer_id)) * 2.5, 2)  -- Assuming 2.5x first-year revenue
        ELSE 0
    END AS customer_ltv
FROM
    MARKETING_CHANNELS mc
LEFT JOIN
    ORDERS o ON mc.marketing_channel_id = o.marketing_channel_id
GROUP BY
    mc.marketing_channel_id, mc.channel_name, mc.channel_type, mc.specific_platform, mc.customer_acquisition_cost
HAVING 
    COUNT(DISTINCT o.customer_id) > 0  -- Only show channels that acquired customers
ORDER BY
    net_revenue DESC, net_roi DESC;               
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Channel Type Comparison
PROMPT 
PROMPT ===== CHANNEL TYPE PERFORMANCE COMPARISON =====

CLEAR COLUMNS

COLUMN marketing_category FORMAT A20 HEADING 'Marketing Category'
COLUMN channel_count FORMAT 999 HEADING 'Channels'
COLUMN avg_acquisition_cost FORMAT $999.99 HEADING 'Avg CAC'
COLUMN avg_conversion_rate FORMAT 990.9 HEADING 'Avg Conv|Rate %'
COLUMN customers_acquired FORMAT 9,999 HEADING 'Customers|Acquired'
COLUMN total_cac_spend FORMAT $99,999.99 HEADING 'Total CAC|Spend'
COLUMN net_revenue FORMAT $999,999.99 HEADING 'Net Revenue'
COLUMN revenue_per_customer FORMAT $9,999.99 HEADING 'Revenue Per|Customer'
COLUMN net_roi FORMAT 990.9 HEADING 'Net ROI'
COLUMN cac_payback_months FORMAT 990.9 HEADING 'Payback|Months'
COLUMN market_share FORMAT 990.9 HEADING 'Revenue|Share %'

-- FIXED: Corrected aggregation logic to avoid ORA-00937 error
WITH channel_metrics AS (
    SELECT
        CASE 
            WHEN mc.channel_type IN ('Social Media', 'Social') THEN 'Social Media'
            WHEN mc.channel_type IN ('Email', 'PPC', 'SEO', 'Display') THEN 'Digital Marketing'
            WHEN mc.channel_type IN ('Direct', 'Referral') THEN 'Organic/Referral'
            ELSE 'Traditional/Other'
        END AS marketing_category,
        mc.marketing_channel_id,
        mc.customer_acquisition_cost,
        mc.conversion_rate
    FROM
        MARKETING_CHANNELS mc
),
revenue_totals AS (
    SELECT SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) AS total_company_revenue
    FROM ORDERS o
),
-- ADDED: Pre-calculate customer counts per channel to fix aggregation issue
channel_customer_counts AS (
    SELECT 
        cm.marketing_channel_id,
        cm.marketing_category,
        cm.customer_acquisition_cost,
        cm.conversion_rate,
        COUNT(DISTINCT o.customer_id) AS customers_per_channel,
        SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) AS revenue_per_channel
    FROM channel_metrics cm
    LEFT JOIN ORDERS o ON cm.marketing_channel_id = o.marketing_channel_id
    GROUP BY cm.marketing_channel_id, cm.marketing_category, cm.customer_acquisition_cost, cm.conversion_rate
)
SELECT
    ccc.marketing_category,
    COUNT(DISTINCT ccc.marketing_channel_id) AS channel_count,
    ROUND(AVG(ccc.customer_acquisition_cost), 2) AS avg_acquisition_cost,
    ROUND(AVG(ccc.conversion_rate), 1) AS avg_conversion_rate,
    SUM(ccc.customers_per_channel) AS customers_acquired,
    -- FIXED: Proper CAC spend calculation
    ROUND(SUM(ccc.customer_acquisition_cost * ccc.customers_per_channel), 2) AS total_cac_spend,
    ROUND(SUM(ccc.revenue_per_channel), 2) AS net_revenue,
    CASE 
        WHEN SUM(ccc.customers_per_channel) > 0 THEN
            ROUND(SUM(ccc.revenue_per_channel) / SUM(ccc.customers_per_channel), 2)
        ELSE 0
    END AS revenue_per_customer,
    CASE 
        WHEN SUM(ccc.customer_acquisition_cost * ccc.customers_per_channel) > 0 THEN
            ROUND(SUM(ccc.revenue_per_channel) / SUM(ccc.customer_acquisition_cost * ccc.customers_per_channel), 1)
        ELSE 0
    END AS net_roi,
    CASE 
        WHEN SUM(ccc.revenue_per_channel) > 0 THEN
            ROUND(SUM(ccc.customer_acquisition_cost * ccc.customers_per_channel) / 
                  (SUM(ccc.revenue_per_channel) / 12), 1)
        ELSE NULL
    END AS cac_payback_months,
    -- FIXED: Market share calculation
    ROUND(SUM(ccc.revenue_per_channel) / 
          (SELECT total_company_revenue FROM revenue_totals) * 100, 1) AS market_share
FROM
    channel_customer_counts ccc
CROSS JOIN
    revenue_totals rt
GROUP BY
    ccc.marketing_category
ORDER BY
    net_revenue DESC;    
            </code></pre>
        </div>
    </div>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- Customer Acquisition Funnel Analysis
PROMPT 
PROMPT ===== CUSTOMER ACQUISITION FUNNEL ANALYSIS =====

CLEAR COLUMNS

COLUMN channel_name FORMAT A25 HEADING 'Marketing Channel'
COLUMN estimated_impressions FORMAT 999,999 HEADING 'Est.|Impressions'
COLUMN conversion_rate FORMAT 990.9 HEADING 'Conv|Rate %'
COLUMN estimated_prospects FORMAT 99,999 HEADING 'Est.|Prospects'
COLUMN customers_acquired FORMAT 999 HEADING 'Customers|Acquired'
COLUMN first_orders FORMAT 999 HEADING 'First|Orders'
COLUMN repeat_customers FORMAT 999 HEADING 'Repeat|Customers'
COLUMN acquisition_rate FORMAT 990.99 HEADING 'Acquisition|Rate %'
COLUMN repeat_rate FORMAT 990.9 HEADING 'Repeat|Rate %'
COLUMN cost_per_impression FORMAT $90.9999 HEADING 'Cost Per|Impression'
COLUMN cost_per_customer FORMAT $999.99 HEADING 'CAC'

-- Enhanced funnel analysis with customer behavior tracking
WITH channel_metrics AS (
    SELECT
        mc.marketing_channel_id,
        mc.channel_name,
        mc.channel_type,
        mc.conversion_rate,
        mc.customer_acquisition_cost,
        -- UPDATED: More sophisticated impression estimates based on channel type
        CASE
            WHEN mc.channel_type = 'Social Media' THEN mc.customer_acquisition_cost * 800
            WHEN mc.channel_type = 'PPC' THEN mc.customer_acquisition_cost * 500
            WHEN mc.channel_type = 'SEO' THEN mc.customer_acquisition_cost * 1200
            WHEN mc.channel_type = 'Email' THEN mc.customer_acquisition_cost * 1500
            WHEN mc.channel_type = 'Display' THEN mc.customer_acquisition_cost * 2000
            WHEN mc.channel_type = 'Direct' THEN mc.customer_acquisition_cost * 300
            WHEN mc.channel_type = 'Referral' THEN mc.customer_acquisition_cost * 200
            ELSE mc.customer_acquisition_cost * 1000
        END AS estimated_impressions
    FROM
        MARKETING_CHANNELS mc
),
customer_behavior AS (
    SELECT 
        o.marketing_channel_id,
        o.customer_id,
        COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END) AS total_orders,
        MIN(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END) AS first_order_date,
        MAX(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END) AS last_order_date
    FROM ORDERS o
    WHERE o.marketing_channel_id IS NOT NULL
    GROUP BY o.marketing_channel_id, o.customer_id
)
SELECT
    cm.channel_name,
    cm.estimated_impressions,
    cm.conversion_rate,
    ROUND(cm.estimated_impressions * (cm.conversion_rate / 100), 0) AS estimated_prospects,
    COUNT(DISTINCT cb.customer_id) AS customers_acquired,
    COUNT(DISTINCT CASE WHEN cb.total_orders >= 1 THEN cb.customer_id END) AS first_orders,
    COUNT(DISTINCT CASE WHEN cb.total_orders > 1 THEN cb.customer_id END) AS repeat_customers,
    CASE 
        WHEN cm.estimated_impressions * (cm.conversion_rate / 100) > 0 THEN
            ROUND(COUNT(DISTINCT cb.customer_id) / (cm.estimated_impressions * (cm.conversion_rate / 100)) * 100, 2)
        ELSE 0
    END AS acquisition_rate,
    -- ADDED: Repeat customer rate
    CASE 
        WHEN COUNT(DISTINCT cb.customer_id) > 0 THEN
            ROUND(COUNT(DISTINCT CASE WHEN cb.total_orders > 1 THEN cb.customer_id END) / 
                  COUNT(DISTINCT cb.customer_id) * 100, 1)
        ELSE 0
    END AS repeat_rate,
    CASE 
        WHEN cm.estimated_impressions > 0 THEN
            ROUND(cm.customer_acquisition_cost / cm.estimated_impressions, 4)
        ELSE 0
    END AS cost_per_impression,
    cm.customer_acquisition_cost AS cost_per_customer
FROM
    channel_metrics cm
LEFT JOIN
    customer_behavior cb ON cm.marketing_channel_id = cb.marketing_channel_id
GROUP BY
    cm.marketing_channel_id, cm.channel_name, cm.estimated_impressions, 
    cm.conversion_rate, cm.customer_acquisition_cost
ORDER BY
    customers_acquired DESC, repeat_rate DESC;         
            </code></pre>
        </div>
    </div>

    <h2 id="req04">Busines Reporting Requirement 04</h2>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- RFM analysis
PROMPT ===== ENHANCED RFM CUSTOMER SEGMENTATION =====

-- Format columns for better readability
COLUMN customer_id FORMAT 999999 HEADING 'Cust ID'
COLUMN customer_name FORMAT A25 HEADING 'Customer Name'
COLUMN email FORMAT A30 HEADING 'Email'
COLUMN last_purchase_date FORMAT A10 HEADING 'Last|Purchase'
COLUMN purchase_frequency FORMAT 999 HEADING 'Purchase|Frequency'
COLUMN total_spent FORMAT $999,990.99 HEADING 'Net Total|Spent'
COLUMN avg_order_value FORMAT $999.99 HEADING 'Avg Order|Value'
COLUMN days_since_last_purchase FORMAT 990.9 HEADING 'Days|Since'
COLUMN recency_score FORMAT 9 HEADING 'R'
COLUMN frequency_score FORMAT 9 HEADING 'F'
COLUMN monetary_score FORMAT 9 HEADING 'M'
COLUMN rfm_value FORMAT A5 HEADING 'RFM|Score'
COLUMN average_score FORMAT 90.9 HEADING 'Avg|Score'
COLUMN customer_segment FORMAT A20 HEADING 'Customer Segment'
COLUMN loyalty_status FORMAT A15 HEADING 'Loyalty|Status'
COLUMN channel_preference FORMAT A10 HEADING 'Channel|Pref'

WITH customer_rfm AS (
    SELECT 
        c.customer_id,
        c.first_name || ' ' || c.last_name AS customer_name,
        c.email,
        c.loyalty_status,
        c.loyalty_points,
        -- UPDATED: Only count valid orders for accurate metrics
        MAX(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END) AS last_purchase_date,
        COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END) AS purchase_frequency,
        -- UPDATED: Use net total amount for accurate spending calculation
        SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) AS total_spent,
        -- ADDED: Average order value calculation
        CASE 
            WHEN COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END) > 0 THEN
                SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.total_amount ELSE 0 END) / 
                COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_id END)
            ELSE 0
        END AS avg_order_value,
        -- ADDED: Channel preference analysis
        CASE 
            WHEN COUNT(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') THEN 1 END) >
                 COUNT(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') THEN 1 END) THEN 'Online'
            WHEN COUNT(CASE WHEN o.platform = 'online' AND o.order_status NOT IN ('Canceled') THEN 1 END) <
                 COUNT(CASE WHEN o.platform = 'in-store' AND o.order_status NOT IN ('Canceled') THEN 1 END) THEN 'In-Store'
            WHEN COUNT(CASE WHEN o.order_status NOT IN ('Canceled') THEN 1 END) > 0 THEN 'Mixed'
            ELSE 'None'
        END AS channel_preference,
        -- UPDATED: Days since last purchase (handle NULL for customers with no orders)
        CASE 
            WHEN MAX(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END) IS NOT NULL THEN
                SYSDATE - MAX(CASE WHEN o.order_status NOT IN ('Canceled') THEN o.order_date END)
            ELSE 9999  -- Assign high value for customers with no orders
        END AS days_since_last_purchase
    FROM CUSTOMERS c
    LEFT JOIN ORDERS o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name, c.email, c.loyalty_status, c.loyalty_points
),
rfm_scores AS (
    SELECT 
        customer_id,
        customer_name,
        email,
        loyalty_status,
        loyalty_points,
        last_purchase_date,
        purchase_frequency,
        total_spent,
        avg_order_value,
        days_since_last_purchase,
        channel_preference,
        -- UPDATED: Enhanced scoring with better handling of edge cases
        CASE 
            WHEN days_since_last_purchase >= 9999 THEN 1  -- No purchases
            ELSE NTILE(5) OVER (ORDER BY days_since_last_purchase ASC)
        END AS recency_score,
        CASE 
            WHEN purchase_frequency = 0 THEN 1  -- No purchases
            ELSE NTILE(5) OVER (ORDER BY purchase_frequency DESC)
        END AS frequency_score,
        CASE 
            WHEN total_spent = 0 THEN 1  -- No spending
            ELSE NTILE(5) OVER (ORDER BY total_spent DESC)
        END AS monetary_score
    FROM customer_rfm
),
segmented_customers AS (
    SELECT 
        customer_id,
        customer_name,
        email,
        loyalty_status,
        loyalty_points,
        last_purchase_date,
        purchase_frequency,
        total_spent,
        avg_order_value,
        days_since_last_purchase,
        channel_preference,
        recency_score,
        frequency_score,
        monetary_score,
        recency_score || frequency_score || monetary_score AS rfm_value,
        ROUND((recency_score + frequency_score + monetary_score) / 3, 1) AS average_score,
        -- UPDATED: More nuanced customer segmentation
        CASE 
            WHEN recency_score >= 4 AND frequency_score >= 4 AND monetary_score >= 4 THEN 'Champions'
            WHEN recency_score >= 4 AND frequency_score >= 4 AND monetary_score >= 3 THEN 'Loyal Customers'
            WHEN recency_score >= 3 AND frequency_score >= 3 AND monetary_score >= 3 THEN 'Potential Loyalists'
            WHEN recency_score >= 4 AND frequency_score <= 2 AND monetary_score <= 3 THEN 'New Customers'
            WHEN recency_score >= 3 AND frequency_score <= 2 AND monetary_score >= 3 THEN 'Big Spenders'
            WHEN recency_score <= 2 AND frequency_score >= 4 AND monetary_score >= 4 THEN 'At Risk'
            WHEN recency_score <= 2 AND frequency_score >= 3 AND monetary_score >= 3 THEN 'Cannot Lose Them'
            WHEN recency_score <= 2 AND frequency_score <= 2 AND monetary_score >= 3 THEN 'Hibernating High Value'
            WHEN recency_score <= 2 AND frequency_score <= 2 AND monetary_score <= 2 THEN 'Hibernating'
            WHEN recency_score <= 1 AND frequency_score <= 1 AND monetary_score <= 1 THEN 'Lost'
            WHEN purchase_frequency = 0 THEN 'No Purchases'
            ELSE 'Need Attention'
        END AS customer_segment
    FROM rfm_scores
)
SELECT 
    customer_id,
    customer_name,
    email,
    loyalty_status,
    last_purchase_date,
    purchase_frequency,
    total_spent,
    avg_order_value,
    ROUND(days_since_last_purchase, 1) AS days_since_last_purchase,
    recency_score,
    frequency_score,
    monetary_score,
    rfm_value,
    average_score,
    customer_segment,
    channel_preference
FROM segmented_customers
ORDER BY average_score DESC, total_spent DESC;        
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">-- promotion response segmentation
PROMPT 
PROMPT ===== ENHANCED PROMOTION RESPONSE SEGMENTATION =====

-- Clear previous column formatting
CLEAR COLUMNS

COLUMN customer_id FORMAT 999999 HEADING 'Cust ID'
COLUMN customer_name FORMAT A25 HEADING 'Customer Name'
COLUMN email FORMAT A30 HEADING 'Email'
COLUMN promotions_offered FORMAT 999 HEADING 'Promos|Offered'
COLUMN promotions_used FORMAT 999 HEADING 'Promos|Used'
COLUMN total_usage_count FORMAT 999 HEADING 'Total|Usage'
COLUMN promotion_response_rate FORMAT 990.9 HEADING 'Response|Rate %'
COLUMN avg_usage_per_promo FORMAT 990.9 HEADING 'Avg Usage|Per Promo'
COLUMN promotion_segment FORMAT A20 HEADING 'Promotion Segment'
COLUMN favorite_promo_type FORMAT A15 HEADING 'Favorite|Promo Type'
COLUMN last_promo_used FORMAT A10 HEADING 'Last Promo|Used'
COLUMN days_since_last_promo FORMAT 999 HEADING 'Days Since|Last Promo'

WITH promotion_analysis AS (
    SELECT 
        c.customer_id,
        c.first_name || ' ' || c.last_name AS customer_name,
        c.email,
        COUNT(DISTINCT cp.customer_promotion_id) AS promotions_offered,
        COUNT(DISTINCT CASE WHEN cp.is_used = 1 THEN cp.customer_promotion_id END) AS promotions_used,
        -- UPDATED: Track total usage count (includes multiple uses of same promotion)
        SUM(COALESCE(cp.times_used, 0)) AS total_usage_count,
        -- ADDED: Average usage per promotion
        CASE 
            WHEN COUNT(DISTINCT CASE WHEN cp.is_used = 1 THEN cp.customer_promotion_id END) > 0 THEN
                SUM(COALESCE(cp.times_used, 0)) / 
                COUNT(DISTINCT CASE WHEN cp.is_used = 1 THEN cp.customer_promotion_id END)
            ELSE 0
        END AS avg_usage_per_promo,
        -- ADDED: Favorite promotion type analysis
        (SELECT p.promotion_type
         FROM CUSTOMER_PROMOTION cp2
         JOIN PROMOTIONS p ON cp2.promotion_id = p.promotion_id
         WHERE cp2.customer_id = c.customer_id AND cp2.times_used > 0
         GROUP BY p.promotion_type
         ORDER BY SUM(cp2.times_used) DESC
         FETCH FIRST 1 ROW ONLY) AS favorite_promo_type,
        -- ADDED: Last promotion usage date
        MAX(CASE WHEN cp.is_used = 1 THEN cp.date_offered END) AS last_promo_used,
        -- ADDED: Days since last promotion usage
        CASE 
            WHEN MAX(CASE WHEN cp.is_used = 1 THEN cp.date_offered END) IS NOT NULL THEN
                SYSDATE - MAX(CASE WHEN cp.is_used = 1 THEN cp.date_offered END)
            ELSE NULL
        END AS days_since_last_promo
    FROM CUSTOMERS c
    LEFT JOIN CUSTOMER_PROMOTION cp ON c.customer_id = cp.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name, c.email
)
SELECT 
    customer_id,
    customer_name,
    email,
    promotions_offered,
    promotions_used,
    total_usage_count,
    CASE 
        WHEN promotions_offered > 0 
        THEN ROUND(promotions_used * 100.0 / promotions_offered, 1)
        ELSE 0 
    END AS promotion_response_rate,
    ROUND(avg_usage_per_promo, 1) AS avg_usage_per_promo,
    -- UPDATED: Enhanced promotion segmentation
    CASE 
        WHEN promotions_offered = 0 THEN 'No Promotions Offered'
        WHEN promotions_used = 0 THEN 'Non-Responder'
        WHEN (promotions_used * 100.0 / promotions_offered) >= 80 AND total_usage_count >= 5 THEN 'Super Responder'
        WHEN (promotions_used * 100.0 / promotions_offered) >= 60 THEN 'High Responder'
        WHEN (promotions_used * 100.0 / promotions_offered) >= 30 THEN 'Medium Responder'
        WHEN (promotions_used * 100.0 / promotions_offered) >= 10 THEN 'Low Responder'
        ELSE 'Minimal Responder'
    END AS promotion_segment,
    COALESCE(favorite_promo_type, 'None') AS favorite_promo_type,
    last_promo_used,
    ROUND(days_since_last_promo, 0) AS days_since_last_promo
FROM promotion_analysis
ORDER BY promotion_response_rate DESC, total_usage_count DESC; 
            </code></pre>
        </div>
    </div>



    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
PROMPT 
PROMPT ===== SUBSCRIPTION CUSTOMER SEGMENTATION =====

CLEAR COLUMNS

COLUMN customer_id FORMAT 999999 HEADING 'Cust ID'
COLUMN customer_name FORMAT A25 HEADING 'Customer Name'
COLUMN subscription_type FORMAT A12 HEADING 'Sub Type'
COLUMN subscription_status FORMAT A10 HEADING 'Status'
COLUMN subscription_duration FORMAT 999 HEADING 'Duration|Days'
COLUMN monthly_value FORMAT $999.99 HEADING 'Monthly|Value'
COLUMN total_subscription_value FORMAT $9,999.99 HEADING 'Total Sub|Value'
COLUMN auto_renewal FORMAT A5 HEADING 'Auto|Renew'
COLUMN delivery_success_rate FORMAT 990.9 HEADING 'Delivery|Success %'
COLUMN subscription_segment FORMAT A20 HEADING 'Subscription Segment'

-- FIXED: Corrected field reference issue
WITH subscription_analysis AS (
    SELECT 
        c.customer_id,
        c.first_name || ' ' || c.last_name AS customer_name,
        s.subscription_type,
        s.subscription_status,
        s.monthly_price,
        s.auto_renewal,
        -- UPDATED: Calculate subscription duration using end_date if available
        CASE 
            WHEN s.end_date IS NOT NULL THEN TRUNC(s.end_date - s.start_date)
            WHEN s.subscription_status = 'Canceled' THEN TRUNC(SYSDATE - s.start_date)
            ELSE TRUNC(SYSDATE - s.start_date)
        END AS subscription_duration,
        -- Calculate total subscription value
        s.monthly_price * 
        CASE 
            WHEN s.end_date IS NOT NULL THEN MONTHS_BETWEEN(s.end_date, s.start_date)
            WHEN s.subscription_status = 'Canceled' THEN MONTHS_BETWEEN(SYSDATE, s.start_date)
            ELSE MONTHS_BETWEEN(SYSDATE, s.start_date)
        END AS total_subscription_value,
        -- ADDED: Delivery success rate calculation
        CASE 
            WHEN COUNT(si.subscription_item_id) > 0 THEN
                COUNT(CASE WHEN si.delivery_status = 'Delivered' THEN 1 END) * 100.0 / COUNT(si.subscription_item_id)
            ELSE NULL
        END AS delivery_success_rate
    FROM CUSTOMERS c
    JOIN SUBSCRIPTIONS s ON c.customer_id = s.customer_id
    LEFT JOIN SUBSCRIPTION_ITEMS si ON s.subscription_id = si.subscription_id
    GROUP BY c.customer_id, c.first_name, c.last_name, s.subscription_type, s.subscription_status,
             s.monthly_price, s.auto_renewal, s.start_date, s.end_date
)
SELECT 
    customer_id,
    customer_name,
    subscription_type,
    subscription_status,
    subscription_duration,
    monthly_price AS monthly_value,  -- FIXED: Use the correct field name
    ROUND(total_subscription_value, 2) AS total_subscription_value,
    CASE WHEN auto_renewal = 1 THEN 'Yes' ELSE 'No' END AS auto_renewal,
    ROUND(delivery_success_rate, 1) AS delivery_success_rate,
    -- Subscription customer segmentation
    CASE 
        WHEN subscription_status = 'Active' AND total_subscription_value >= 500 AND auto_renewal = 1 THEN 'VIP Subscriber'
        WHEN subscription_status = 'Active' AND total_subscription_value >= 200 THEN 'Loyal Subscriber'
        WHEN subscription_status = 'Active' AND subscription_duration >= 90 THEN 'Committed Subscriber'
        WHEN subscription_status = 'Active' AND subscription_duration < 30 THEN 'New Subscriber'
        WHEN subscription_status = 'Active' THEN 'Regular Subscriber'
        WHEN subscription_status = 'Paused' AND total_subscription_value >= 200 THEN 'High-Value Paused'
        WHEN subscription_status = 'Paused' THEN 'Paused Subscriber'
        WHEN subscription_status = 'Canceled' AND subscription_duration >= 180 THEN 'Long-term Churned'
        WHEN subscription_status = 'Canceled' AND subscription_duration >= 30 THEN 'Churned Subscriber'
        ELSE 'Early Churned'
    END AS subscription_segment
FROM subscription_analysis
ORDER BY total_subscription_value DESC, subscription_duration DESC;  
            </code></pre>
        </div>
    </div>

<h2 id="req05">Busines Reporting Requirement 05</h2>

    <div class="code-section">
        <div class="code-header">Global Display Formatting </div>
        <div class="code-description">different from the previous queries</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
-- Set up display format for all queries
SET LINESIZE 250
SET PAGESIZE 1000
SET TRIMOUT ON
SET TRIMSPOOL ON
SET TAB OFF
SET WRAP ON
SET HEADING ON
SET UNDERLINE ON
SET FEEDBACK ON
SET ECHO OFF
SET VERIFY OFF

-- Format date display
ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD';
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
PROMPT ===== K-POP/ANIME PRODUCT PERFORMANCE ANALYSIS =====

-- Format columns for better readability
COLUMN product_id FORMAT 999 HEADING 'Prod|ID'
COLUMN product_name FORMAT A25 HEADING 'Product Name'
COLUMN kpop_anime_tie_in FORMAT A15 HEADING 'K-Pop/Anime|Theme'
COLUMN category FORMAT A12 HEADING 'Category'
COLUMN base_price FORMAT $999.99 HEADING 'Base|Price'
COLUMN units_sold FORMAT 9,999 HEADING 'Units|Sold'
COLUMN gross_revenue FORMAT $99,999.99 HEADING 'Gross|Revenue'
COLUMN net_revenue FORMAT $99,999.99 HEADING 'Net Revenue|After Discounts'
COLUMN avg_selling_price FORMAT $999.99 HEADING 'Avg Selling|Price'
COLUMN days_available FORMAT 999 HEADING 'Days|Available'
COLUMN sales_per_day FORMAT 990.99 HEADING 'Daily|Sales'
COLUMN avg_rating FORMAT 90.9 HEADING 'Avg|Rating'
COLUMN stock_status FORMAT A12 HEADING 'Stock|Status'
COLUMN urgency_level FORMAT A10 HEADING 'Urgency'

-- FIXED: Corrected date arithmetic to avoid INTERVAL data type issues
SELECT 
    p.product_id,
    p.product_name,
    p.kpop_anime_tie_in,
    p.category,
    p.base_price,
    -- Only count valid orders
    NVL(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) AS units_sold,
    -- Gross revenue calculation (before discounts)
    NVL(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                 THEN oi.quantity * oi.unit_price ELSE 0 END), 0) AS gross_revenue,
    -- Net revenue after item-level discounts
    NVL(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                 THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                 ELSE 0 END), 0) AS net_revenue,
    -- Average selling price per unit (after discounts)
    CASE 
        WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) > 0 THEN
            SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                     THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                     ELSE 0 END) / 
            SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END)
        ELSE 0
    END AS avg_selling_price,
    -- FIXED: Days available calculation using proper date arithmetic
    CASE 
        WHEN p.expiry_date IS NOT NULL THEN 
            GREATEST(1, 
                TRUNC(LEAST(SYSDATE, p.expiry_date)) - 
                TRUNC(GREATEST(TRUNC(p.created_at), TRUNC(SYSDATE - 365)))
            )
        ELSE 
            GREATEST(1, 
                TRUNC(SYSDATE) - 
                TRUNC(GREATEST(TRUNC(p.created_at), TRUNC(SYSDATE - 365)))
            )
    END AS days_available,
    -- FIXED: Sales per day calculation using the corrected days_available
    CASE 
        WHEN GREATEST(1, 
                CASE 
                    WHEN p.expiry_date IS NOT NULL THEN 
                        TRUNC(LEAST(SYSDATE, p.expiry_date)) - 
                        TRUNC(GREATEST(TRUNC(p.created_at), TRUNC(SYSDATE - 365)))
                    ELSE 
                        TRUNC(SYSDATE) - 
                        TRUNC(GREATEST(TRUNC(p.created_at), TRUNC(SYSDATE - 365)))
                END) > 0
        THEN 
            NVL(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0) / 
            GREATEST(1, 
                CASE 
                    WHEN p.expiry_date IS NOT NULL THEN 
                        TRUNC(LEAST(SYSDATE, p.expiry_date)) - 
                        TRUNC(GREATEST(TRUNC(p.created_at), TRUNC(SYSDATE - 365)))
                    ELSE 
                        TRUNC(SYSDATE) - 
                        TRUNC(GREATEST(TRUNC(p.created_at), TRUNC(SYSDATE - 365)))
                END)
        ELSE 0
    END AS sales_per_day,
    -- Only count verified feedback
    NVL(AVG(CASE WHEN f.is_verified_purchase = 1 THEN f.rating END), 0) AS avg_rating,
    -- Stock status from inventory
    CASE 
        WHEN i.current_stock = 0 THEN 'Out of Stock'
        WHEN i.current_stock <= i.min_stock_level THEN 'Critical'
        WHEN i.current_stock <= i.reorder_point THEN 'Low Stock'
        ELSE 'In Stock'
    END AS stock_status,
    -- Urgency level for limited edition items
    CASE
        WHEN p.expiry_date IS NOT NULL THEN
            CASE
                WHEN TRUNC(p.expiry_date) - TRUNC(SYSDATE) <= 3 AND i.current_stock > 0 THEN 'Emergency'
                WHEN TRUNC(p.expiry_date) - TRUNC(SYSDATE) <= 7 AND i.current_stock > 0 THEN 'Critical'
                WHEN TRUNC(p.expiry_date) - TRUNC(SYSDATE) <= 14 AND i.current_stock > 0 THEN 'High'
                WHEN TRUNC(p.expiry_date) - TRUNC(SYSDATE) <= 30 AND i.current_stock > 0 THEN 'Medium'
                WHEN TRUNC(p.expiry_date) - TRUNC(SYSDATE) < 0 THEN 'Expired'
                ELSE 'Low'
            END
        WHEN p.limited_edition = 1 AND i.current_stock <= i.min_stock_level THEN 'Critical'
        ELSE 'Normal'
    END AS urgency_level
FROM 
    PRODUCTS p
    LEFT JOIN ORDER_ITEMS oi ON p.product_id = oi.product_id
    LEFT JOIN ORDERS o ON oi.order_id = o.order_id
    LEFT JOIN FEEDBACK f ON p.product_id = f.product_id
    LEFT JOIN INVENTORY i ON p.product_id = i.product_id
WHERE 
    p.limited_edition = 1 
    AND p.kpop_anime_tie_in IS NOT NULL
GROUP BY 
    p.product_id, p.product_name, p.kpop_anime_tie_in, p.category, p.base_price, 
    p.expiry_date, p.created_at, p.limited_edition, 
    i.current_stock, i.min_stock_level, i.reorder_point
ORDER BY 
    sales_per_day DESC, net_revenue DESC;
            </code></pre>
        </div>
    </div>

<h2 id="req05">Busines Reporting Requirement 06</h2>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
-- Set up display format for all queries
SET LINESIZE 250
SET PAGESIZE 1000
SET TRIMOUT ON
SET TRIMSPOOL ON
SET TAB OFF
SET WRAP ON
SET HEADING ON
SET UNDERLINE ON
SET FEEDBACK ON
SET ECHO OFF
SET VERIFY OFF        
            </code></pre>
        </div>
    </div>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
PROMPT ===== PLATFORM-SPECIFIC PROMOTION EFFECTIVENESS ANALYSIS =====

-- Format columns for better readability
COLUMN platform FORMAT A12 HEADING 'Platform'
COLUMN promotion_type FORMAT A15 HEADING 'Promotion Type'
COLUMN promo_count FORMAT 999 HEADING 'Total|Promos'
COLUMN customers_reached FORMAT 999 HEADING 'Customers|Reached'
COLUMN total_orders FORMAT 999 HEADING 'Total|Orders'
COLUMN gross_revenue FORMAT $999,999.99 HEADING 'Gross|Revenue'
COLUMN net_revenue FORMAT $999,999.99 HEADING 'Net Revenue|After Discounts'
COLUMN total_discount_given FORMAT $99,999.99 HEADING 'Total|Discounts'
COLUMN avg_discount_pct FORMAT 990.9 HEADING 'Avg|Discount %'
COLUMN avg_order_value FORMAT $999.99 HEADING 'Avg Order|Value'
COLUMN roi FORMAT 990.9 HEADING 'ROI %'
COLUMN response_rate FORMAT 990.9 HEADING 'Response|Rate %'
COLUMN usage_rate FORMAT 990.9 HEADING 'Usage|Rate %'

-- UPDATED: Enhanced query with proper revenue calculations and business logic
WITH promotion_orders AS (
    -- Find orders that used promotions during the promotion period
    SELECT DISTINCT
        p.promotion_id,
        p.platform,
        p.promotion_type,
        p.discount_amount,
        p.discount_type,
        p.start_date,
        p.end_date,
        o.order_id,
        o.customer_id,
        o.order_date,
        -- UPDATED: Use total_amount for net revenue (includes all order components)
        o.total_amount,
        -- UPDATED: Calculate gross revenue (before order-level discounts)
        o.subtotal + COALESCE(o.tax_amount, 0) + COALESCE(o.shipping_cost, 0) AS gross_amount,
        -- UPDATED: Get actual discount applied at order level
        COALESCE(o.discount_amount, 0) AS actual_order_discount
    FROM PROMOTIONS p
    LEFT JOIN CUSTOMER_PROMOTION cp ON p.promotion_id = cp.promotion_id 
    LEFT JOIN ORDERS o ON cp.customer_id = o.customer_id 
                      AND o.platform = p.platform
                      AND o.order_date BETWEEN p.start_date AND p.end_date
                      AND o.order_status NOT IN ('Canceled')  -- UPDATED: Only valid orders
                      AND cp.is_used = 1  -- Only used promotions
),
promotion_metrics AS (
    SELECT 
        p.platform,
        p.promotion_type,
        COUNT(DISTINCT p.promotion_id) AS promo_count,
        COUNT(DISTINCT cp.customer_id) AS customers_reached,
        COUNT(DISTINCT po.order_id) AS total_orders,
        SUM(COALESCE(po.gross_amount, 0)) AS gross_revenue,
        SUM(COALESCE(po.total_amount, 0)) AS net_revenue,
        SUM(COALESCE(po.actual_order_discount, 0)) AS total_discount_given,
        -- Promotion usage statistics
        SUM(cp.times_used) AS total_usage_count,
        COUNT(DISTINCT CASE WHEN cp.is_used = 1 THEN cp.customer_promotion_id END) AS promotions_used,
        COUNT(DISTINCT cp.customer_promotion_id) AS promotions_offered
    FROM PROMOTIONS p
    LEFT JOIN CUSTOMER_PROMOTION cp ON p.promotion_id = cp.promotion_id
    LEFT JOIN promotion_orders po ON p.promotion_id = po.promotion_id
    WHERE p.platform != 'both'  -- Exclude promotions available on both platforms
    GROUP BY p.platform, p.promotion_type
)
SELECT
    pm.platform,
    pm.promotion_type,
    pm.promo_count,
    pm.customers_reached,
    pm.total_orders,
    ROUND(pm.gross_revenue, 2) AS gross_revenue,
    ROUND(pm.net_revenue, 2) AS net_revenue,
    ROUND(pm.total_discount_given, 2) AS total_discount_given,
    -- Average discount percentage
    CASE 
        WHEN pm.gross_revenue > 0 THEN 
            ROUND(pm.total_discount_given / pm.gross_revenue * 100, 1)
        ELSE 0
    END AS avg_discount_pct,
    -- Average order value (net)
    CASE 
        WHEN pm.total_orders > 0 THEN 
            ROUND(pm.net_revenue / pm.total_orders, 2)
        ELSE 0
    END AS avg_order_value,
    -- UPDATED: ROI calculation (Revenue generated vs discount cost)
    CASE 
        WHEN pm.total_discount_given > 0 THEN
            ROUND((pm.net_revenue - pm.total_discount_given) / pm.total_discount_given * 100, 1)
        ELSE 0
    END AS roi,
    -- Response rate: % of customers who used promotions
    CASE 
        WHEN pm.promotions_offered > 0 THEN
            ROUND(pm.promotions_used / pm.promotions_offered * 100, 1)
        ELSE 0
    END AS response_rate,
    -- Usage rate: average times used per promotion
    CASE 
        WHEN pm.promotions_used > 0 THEN
            ROUND(pm.total_usage_count / pm.promotions_used, 1)
        ELSE 0
    END AS usage_rate
FROM promotion_metrics pm
WHERE pm.promo_count > 0  -- Only show platforms with promotions
ORDER BY 
    pm.platform, pm.net_revenue DESC; 
            </code></pre>
        </div>
    </div>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
PROMPT 
PROMPT ===== PRODUCT CATEGORY PREFERENCES BY PLATFORM =====

-- Clear previous column formatting
CLEAR COLUMNS

-- Format columns for better readability
COLUMN platform FORMAT A12 HEADING 'Platform'
COLUMN category FORMAT A15 HEADING 'Product Category'
COLUMN total_orders FORMAT 999 HEADING 'Total|Orders'
COLUMN total_items FORMAT 9,999 HEADING 'Total|Items'
COLUMN gross_revenue FORMAT $999,999.99 HEADING 'Gross|Revenue'
COLUMN net_revenue FORMAT $999,999.99 HEADING 'Net Revenue|After Discounts'
COLUMN revenue_share FORMAT 990.9 HEADING 'Revenue|Share %'
COLUMN avg_selling_price FORMAT $99.99 HEADING 'Avg Selling|Price'
COLUMN theme_product_pct FORMAT 990.9 HEADING 'K-Pop/Anime|%'
COLUMN limited_edition_pct FORMAT 990.9 HEADING 'Limited|Edition %'
COLUMN avg_discount_per_item FORMAT $99.99 HEADING 'Avg Discount|Per Item'

-- UPDATED: Enhanced query with proper revenue calculations
SELECT
    o.platform,
    p.category,
    COUNT(DISTINCT o.order_id) AS total_orders,
    SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) AS total_items,
    -- UPDATED: Gross revenue calculation (before item discounts)
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                   THEN oi.quantity * oi.unit_price ELSE 0 END), 2) AS gross_revenue,
    -- UPDATED: Net revenue calculation (after item discounts)
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END), 2) AS net_revenue,
    -- Revenue share within platform
    ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                   THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                   ELSE 0 END) * 100 / 
          SUM(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                       THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                       ELSE 0 END)) OVER (PARTITION BY o.platform), 1) AS revenue_share,
    -- UPDATED: Average selling price per unit (after discounts)
    CASE 
        WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) > 0 THEN
            ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                           THEN (oi.quantity * oi.unit_price) - COALESCE(oi.discount, 0) 
                           ELSE 0 END) / 
                  SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 2)
        ELSE 0
    END AS avg_selling_price,
    -- K-Pop/Anime themed product percentage
    ROUND(SUM(CASE WHEN p.kpop_anime_tie_in IS NOT NULL AND o.order_status NOT IN ('Canceled') 
                   THEN oi.quantity ELSE 0 END) * 100.0 / 
          NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0), 1) AS theme_product_pct,
    -- ADDED: Limited edition product percentage
    ROUND(SUM(CASE WHEN p.limited_edition = 1 AND o.order_status NOT IN ('Canceled') 
                   THEN oi.quantity ELSE 0 END) * 100.0 / 
          NULLIF(SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 0), 1) AS limited_edition_pct,
    -- ADDED: Average discount per item
    CASE 
        WHEN SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) > 0 THEN
            ROUND(SUM(CASE WHEN o.order_status NOT IN ('Canceled') 
                           THEN COALESCE(oi.discount, 0) ELSE 0 END) / 
                  SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END), 2)
        ELSE 0
    END AS avg_discount_per_item
FROM
    ORDERS o
    JOIN ORDER_ITEMS oi ON o.order_id = oi.order_id
    JOIN PRODUCTS p ON oi.product_id = p.product_id
GROUP BY
    o.platform, p.category
HAVING
    SUM(CASE WHEN o.order_status NOT IN ('Canceled') THEN oi.quantity ELSE 0 END) > 0  -- Only categories with sales
ORDER BY
    o.platform, net_revenue DESC;     
            </code></pre>
        </div>
    </div>

<h2 id="req07">Busines Reporting Requirement 07</h2>


    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
-- Set up display format for all queries
SET LINESIZE 250
SET PAGESIZE 1000
SET TRIMOUT ON
SET TRIMSPOOL ON
SET TAB OFF
SET WRAP ON
SET HEADING ON
SET UNDERLINE ON
SET FEEDBACK ON
SET ECHO OFF
SET VERIFY OFF

-- Format date display
ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD';    
            </code></pre>
        </div>
    </div>

    <div class="code-section">
        <div class="code-header">xxxx</div>
        <div class="code-description">xxxxx</div>
        <div class="code-container">
            
            <pre><code class="language-sql">
PROMPT ===== GIFT CARD SALES OVERVIEW DASHBOARD =====

-- Format columns for enhanced display
COLUMN period FORMAT A10 HEADING 'Period'
COLUMN total_cards_issued FORMAT 999,999 HEADING 'Cards|Issued'
COLUMN total_value_issued FORMAT $999,999.99 HEADING 'Total Value|Issued'
COLUMN avg_card_value FORMAT $999.99 HEADING 'Avg Card|Value'
COLUMN gift_purchases FORMAT 999,999 HEADING 'As Gift|Purchases'
COLUMN self_purchases FORMAT 999,999 HEADING 'Self|Purchases'
COLUMN unique_purchasers FORMAT 999,999 HEADING 'Unique|Purchasers'
COLUMN cards_redeemed FORMAT 999,999 HEADING 'Cards|Redeemed'
COLUMN total_redeemed_value FORMAT $999,999.99 HEADING 'Value|Redeemed'
COLUMN redemption_rate FORMAT 990.9 HEADING 'Redemption|Rate %'
COLUMN avg_days_to_redeem FORMAT 999 HEADING 'Avg Days|To Redeem'
COLUMN outstanding_balance FORMAT $999,999.99 HEADING 'Outstanding|Balance'

-- UPDATED: Enhanced query with comprehensive gift card metrics
WITH monthly_sales AS (
    SELECT 
        TO_CHAR(gc.issue_date, 'YYYY-MM') AS period,
        COUNT(*) AS total_cards_issued,
        SUM(gc.initial_amount) AS total_value_issued,
        ROUND(AVG(gc.initial_amount), 2) AS avg_card_value,
        -- Enhanced gift vs self purchase classification
        COUNT(CASE WHEN gc.recipient_customer_id IS NOT NULL AND 
                        gc.recipient_customer_id != gc.issuer_customer_id THEN 1 END) AS gift_purchases,
        COUNT(CASE WHEN gc.recipient_customer_id IS NULL OR 
                        gc.recipient_customer_id = gc.issuer_customer_id THEN 1 END) AS self_purchases,
        COUNT(DISTINCT gc.issuer_customer_id) AS unique_purchasers,
        -- ADDED: Redemption metrics
        COUNT(CASE WHEN gc.is_redeemed = 1 THEN 1 END) AS cards_redeemed,
        SUM(CASE WHEN gc.is_redeemed = 1 THEN gc.initial_amount - gc.current_balance ELSE 0 END) AS total_redeemed_value,
        -- ADDED: Outstanding balance tracking
        SUM(gc.current_balance) AS outstanding_balance,
        -- ADDED: Average redemption time (for redeemed cards)
        ROUND(AVG(CASE WHEN gc.is_redeemed = 1 THEN 
                      (SELECT MIN(o.order_date) - gc.issue_date 
                       FROM ORDERS o 
                       WHERE o.gift_card_id = gc.gift_card_id)
                  END), 0) AS avg_days_to_redeem
    FROM GIFT_CARDS gc
    GROUP BY TO_CHAR(gc.issue_date, 'YYYY-MM')
),
enhanced_metrics AS (
    SELECT 
        ms.*,
        -- Calculate redemption rate
        CASE 
            WHEN ms.total_cards_issued > 0 THEN
                ROUND(ms.cards_redeemed / ms.total_cards_issued * 100, 1)
            ELSE 0
        END AS redemption_rate
    FROM monthly_sales ms
)
SELECT 
    em.period,
    em.total_cards_issued,
    em.total_value_issued,
    em.avg_card_value,
    em.gift_purchases,
    em.self_purchases,
    em.unique_purchasers,
    em.cards_redeemed,
    ROUND(em.total_redeemed_value, 2) AS total_redeemed_value,
    em.redemption_rate,
    em.avg_days_to_redeem,
    ROUND(em.outstanding_balance, 2) AS outstanding_balance
FROM enhanced_metrics em
ORDER BY em.period DESC;     
            </code></pre>
        </div>
    </div>
